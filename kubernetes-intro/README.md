Для успешного выполнения последующих домашних заданий
вам потребуется добавить в репозиторий несколько файлов:
.travis.yml со - необходим для
автоматизированной проверки ДЗ
.github/PULL_REQUEST_TEMPLATE.md со
- шаблон для описания PR
.github/auto_assign.yml со - файл
конфигурации для плагина
следующим содержимым
следующим
содержимым
следующим содержимым
Auto Assign
Обратите внимание, что расширение у файла .travis.yml
должно быть yml, а не yaml
Избавляем бизнес от ИТ-зависимости
1 . 2
Выполнение
Склонируйте репозиторий https://github.com/otus-kuber2020-04/<your_name>_platform на локальную машину
Создайте новую ветку kubernetes-prepare:
Поместите в репозиторий перечисленные на предыдущем слайде
файлы
Сделайте commit и push в GitHub:
git checkout -b kubernetes-prepare
git add -A
git commit -am 'Add hw files'
git push origin kubernetes-prepare
Избавляем бизнес от ИТ-зависимости
1 . 3
Выполнение | GitHub
Создайте Pull Request из ветки kubernetes-prepare в ветку
master
После того как автоматизированные тесты отработают,
необходимо сделать merge ветки kubernetes-prepare в master и
закрыть PR
Избавляем бизнес от ИТ-зависимости
1 . 4
Проверка ДЗ
Структура репозитория после выполнения подготовки:
├── .github
│ └── PULL_REQUEST_TEMPLATE.md
| └── auto_assign.yml
├── .travis.yml
├── LICENSE
├── README.md
Избавляем бизнес от ИТ-зависимости
1 . 5
Настройка локального
окружения. Запуск
первого контейнера.
Работа с kubectl
Избавляем бизнес от ИТ-зависимости
2 . 1
Установка kubectl
kubectl - консольная утилита для управления кластерами
Kubernetes.
Установим последнюю доступную версию kubectl на локальную
машину. Инструкции по установке доступны по ссылке.
Не забудьте настроить для используемого
shell
автодополнение
Избавляем бизнес от ИТ-зависимости
2 . 2
Установка Minikube
Minikube - наиболее универсальный вариант для
развертывания локального окружения.
Установим последнюю доступную версию Minikube на
локальную машину. Инструкции по установке доступны по ссылке.
Minkube - только один из способов быстрого получения
локального окружения. В домашних работах мы также будем
использовать kind там, где это необходимо.
Избавляем бизнес от ИТ-зависимости
2 . 3
Запуск Minikube
После установки запустим виртуальную машину с кластером
Kubernetes командой minikube start.
В зависимости от используемой операционной системы для
успешного старта могут потребоваться дополнительные
флаги.
Избавляем бизнес от ИТ-зависимости
2 . 4
Запуск Minikube
После запуска, Minikube должен автоматически настроить
kubectl и создать контекст minikube. Посмотреть текущую
конфигурацию kubectl можно командой kubectl config view.
Проверим, что подключение к кластеру работает корректно:
Вывод должен выглядеть следующим образом:
kubectl cluster-info
Kubernetes master is running at https://192.168.99.100:8443
KubeDNS is running at https://192.168.99.100:8443/api/v1/namespaces/kubesystem/services/kube-dns:dns/proxy
Избавляем бизнес от ИТ-зависимости
2 . 5
Kubernetes Dashboard
Один из наиболее часто устанавливаемых аддонов для
Kubernetes -
В курсе мы будем взаимодействовать с кластером другими
способами, но при желании Dashboard можно подключить как
Addon в Minikube и изучить его возможности.
Dashboard
Избавляем бизнес от ИТ-зависимости
2 . 6
k9s
Удобный способ визуализации консольной работы с кластером -
k9s
Мы не навязываем использование k9s, но рекомендуем
попробовать некоторое время поработать с ним
Избавляем бизнес от ИТ-зависимости
2 . 7
Minikube
При установке кластера с использованием Minikube будет
создана виртуальная машина в которой будут работать все
системные компоненты кластера Kubernetes.
Можем убедиться в этом, зайдем на ВМ по SSH и посмотрим
запущенные Docker контейнеры:
Проверим, что Kubernetes обладает некоторой устойчивостью к
отказам, удалим все контейнеры:
minikube ssh
docker ps
docker rm -f $(docker ps -a -q)
Избавляем бизнес от ИТ-зависимости
2 . 8
kubectl
Эти же компоненты, но уже в виде pod можно увидеть в
namespace kube-system:
Расшифруем: данной командой мы запросили у API вывести
список (get) всех pod (pods) в namespace (-n, сокращенное от --
namespace) kube-system.
Можно устроить еще одну проверку на прочность и удалить все
pod с системными компонентами:
kubectl get pods -n kube-system
kubectl delete pod --all -n kube-system
Избавляем бизнес от ИТ-зависимости
2 . 9
kubectl
Проверим, что кластер находится в рабочем состоянии,
команды:
или сокращенно:
выведут состояние системных компонентов:
kubectl get componentstatuses
kubectl get cs
NAME STATUS MESSAGE ERROR
controller-manager Healthy ok
scheduler Healthy ok
etcd-0 Healthy {"health":"true"}
Избавляем бизнес от ИТ-зависимости
2 . 10
Задание
Разберитесь почему все pod в namespace kube-system
восстановились после удаления. Укажите причину в описании PR
Hint: core-dns и, например, kube-apiserver, имеют
различия в механизме запуска и восстанавливаются по
разным причинам
Избавляем бизнес от ИТ-зависимости
2 . 11
Dockerfile
Для выполнения домашней работы необходимо создать
Dockerfile, в котором будет описан образ:
. Запускающий web-сервер на порту 8000 (можно использовать
любой способ)
. Отдающий содержимое директории /app внутри контейнера
(например, если в директории /app лежит файл homework.html, то
при запуске контейнера данный файл должен быть доступен по
URL http://localhost:8000/homework.html)
. Работающий с UID 1001
Избавляем бизнес от ИТ-зависимости
2 . 12
Dockerfile
После того, как Dockerfile будет готов:
В корне репозитория создайте директорию kubernetesintro/web и поместите туда готовый Dockerfile
Соберите из Dockerfile образ контейнера и поместите его в
публичный Container Registry (например, Docker Hub)
Избавляем бизнес от ИТ-зависимости
2 . 13
Манифест pod
Напишем манифест web-pod.yaml для создания pod web c
меткой app со значением web, содержащего один контейнер с
названием web. Необходимо использовать ранее собранный образ
с Docker Hub.
При написании манифеста можно воспользоваться следующим
шаблоном:
apiVersion: v1 # Версия API
kind: Pod # Объект, который создаем
metadata:
name: # Название Pod
labels: # Метки в формате key: value
key: value
spec: # Описание Pod
containers: # Описание контейнеров внутри Pod
- name: # Название контейнера
image: # Образ из которого создается контейнер
Избавляем бизнес от ИТ-зависимости
2 . 14
Манифест pod
Поместите манифест web-pod.yaml в директорию kubernetesintro и примените его:
После этого в кластере в namespace default должен появиться
запущенный pod web:
kubectl apply -f web-pod.yaml
kubectl get pods
NAME READY STATUS RESTARTS AGE
web 1/1 Running 0 42s
Избавляем бизнес от ИТ-зависимости
2 . 15
Манифест pod
В Kubernetes есть возможность получить манифест уже
запущенного в кластере pod.
В подобном манифесте помимо описания pod будут
фигурировать служебные поля (например, различные статусы) и
значения, подставленные по умолчанию.
kubectl get pod web -o yaml
Избавляем бизнес от ИТ-зависимости
2 . 16
kubectl describe
Другой способ посмотреть описание pod - использовать ключ
describe. Команда позволяет отследить текущее состояние
объекта, а также события, которые с ним происходили
kubectl describe pod web
Избавляем бизнес от ИТ-зависимости
2 . 17
kubectl describe
Успешный старт pod в kubectl describe выглядит следующим
образом:
. scheduler определил, на какой ноде запускать pod
. kubelet скачал необходимый образ и запустил контейнер
Events:
Type Reason Age From Message
---- ------ ---- ---- -------
Normal Scheduled 10s default-scheduler Successfully assigned default/web to
minikube
Normal Pulling 8s kubelet, minikube Pulling image "web:1.0"
Normal Pulled 3s kubelet, minikube Successfully pulled image "web:1.0"
Normal Created 3s kubelet, minikube Created container nginx
Normal Started 2s kubelet, minikube Started container nginx
Избавляем бизнес от ИТ-зависимости
2 . 18
kubectl describe
При этом kubectl describe - хороший старт для поиска причин
проблем с запуском pod.
Укажите в манифесте несуществующий тег образа web и
примените его заново (kubectl apply -f web-pod.yaml).
Статус pod (kubectl get pods) должен измениться на
ErrImagePull/ImagePullBackOff, а команда kubectl describe pod
web поможет понять причину такого поведения:
Events:
Type Reason Age From Message
---- ------ ---- ---- -------
Warning Failed 2s kubelet, minikube Failed to pull image "web:broken-tag": rpc
error: code = Unknown desc = Error response from daemon: manifest for web:broken-tag not
found
Избавляем бизнес от ИТ-зависимости
2 . 19
kubectl describe
Вывод kubectl describe pod web если мы забыли, что
Container Registry могут быть приватными:
Events:
Type Reason Age From Message
---- ------ ---- ---- -------
Warning Failed 2s kubelet, minikube Failed to pull image
"quay.io/example/web:1.0": rpc error: code = Unknown desc =Error response from daemon:
unauthorized: access to the requested resource is not authorized
Избавляем бизнес от ИТ-зависимости
2 . 20
Init контейнеры
Добавим в наш pod , генерирующий страницу
index.html.
Init контейнеры описываются аналогично обычным
контейнерам в pod. Добавьте в манифест web-pod.yaml описание
init контейнера, соответствующее следующим требованиям:
image init контейнера должен содержать wget (например, можно
использовать busybox:1.31.0 или любой другой busybox
актуальной версии)
command init контейнера (аналог ENTRYPOINT в Dockerfile) укажите
следующую:
init контейнер
['sh', '-c', 'wget -O- https://tinyurl.com/otus-k8s-intro | sh']
Избавляем бизнес от ИТ-зависимости
2 . 21
Volumes
Для того, чтобы файлы, созданные в init контейнере, были
доступны основному контейнеру в pod нам понадобится
использовать volume типа emptyDir.
В следующих лекциях мы расскажем про volume подробнее, а
пока будем руководствоваться подсказками:
У контейнера и у init контейнера должны быть описаны
volumeMounts следующего вида
volumeMounts:
- name: app
mountPath: /app
Избавляем бизнес от ИТ-зависимости
2 . 22
Volumes
Для того, чтобы файлы, созданные в init контейнере, были
доступны основному контейнеру в pod нам понадобится
использовать volume типа emptyDir.
В следующих лекциях мы расскажем про volume подробнее, а
пока будем руководствоваться подсказками:
volume должен быть описан в спецификации pod
volumes:
- name: app
emptyDir: {}
Избавляем бизнес от ИТ-зависимости
2 . 23
Запуск pod
Удалите запущенный pod web из кластера (kubectl delete pod
web) и примените обновленный манифест web-pod.yaml
Отслеживать происходящее можно с использованием команды
kubectl get pods -w
Должен получиться аналогичный вывод:
kubectl apply -f web-pod.yaml && kubectl get pods -w
pod/web created
NAME READY STATUS RESTARTS AGE
web 0/1 Init:0/1 0 0s
web 0/1 Init:0/1 0 1s
web 0/1 PodInitializing 0 2s
web 1/1 Running 0 3s
Избавляем бизнес от ИТ-зависимости
2 . 24
Проверка работы приложения
Проверим работоспособность web сервера. Существует
несколько способов получить доступ к pod, запущенным внутри
кластера.
Мы воспользуемся командой
Если все выполнено правильно, на локальном компьютере по
ссылке должна открыться страница.
kubectl port-forward
kubectl port-forward --address 0.0.0.0 pod/web 8000:8000
http://localhost:8000/index.html
Избавляем бизнес от ИТ-зависимости
2 . 25
kube-forwarder
В качестве альтернативы kubectl port-forward можно
использовать удобную обертку . Она отлично
подходит для доступа к pod внутри кластера с локальной машины
во время разработки продукта.
kube-forwarder
Избавляем бизнес от ИТ-зависимости
2 . 26
Hipster Shop
В последующих домашних заданиях мы будем использовать
микросервисное приложение Hipster Shop
Избавляем бизнес от ИТ-зависимости
3 . 1
Hipster Shop
Давайте познакомимся с приложением поближе и попробуем
запустить внутри нашего кластера его компоненты.
Начнем с микросервиса frontend. Его исходный код доступен
по .
Склонируйте и соберите собственный образ для
frontend (используйте готовый Dockerfile)
Поместите собранный образ на Docker Hub
адресу
репозиторий
❗Не добавляйте содержимое репозитория microservicesdemo в ваш PR
Избавляем бизнес от ИТ-зависимости
3 . 2
Hipster Shop
Рассмотрим альтернативный способ запуска pod в нашем
Kubernetes кластере.
Вы уже умеете работать с манифестами (и это наиболее
корректный подход к развертыванию ресурсов в Kubernetes), но
иногда бывает удобно использовать ad-hoc режим и возможности
Kubectl для создания ресурсов.
Избавляем бизнес от ИТ-зависимости
3 . 3
Hipster Shop
Разберем пример для запуска frontend pod:
kubectl run - запустить ресурс
frontend - с именем frontend
--image - из образа avtandilko/hipster-frontend:v0.0.1
(подставьте свой образ)
--restart=Never указываем на то, что в качестве ресурса запускаем
pod.
kubectl run frontend --image avtandilko/hipster-frontend:v0.0.1 --restart=Never
Подробности
Избавляем бизнес от ИТ-зависимости
3 . 4
Hipster Shop
Один из распространенных кейсов использования ad-hoc
режима - генерация манифестов средствами kubectl:
Рассмотрим дополнительные ключи:
--dry-run - вывод информации о ресурсе без его реального
создания
-o yaml - форматирование вывода в YAML
> frontend-pod.yaml - перенаправление вывода в файл
kubectl run frontend --image avtandilko/hipster-frontend:v0.0.1 --restart=Never --dryrun -o yaml > frontend-pod.yaml
Избавляем бизнес от ИТ-зависимости
3 . 5
Hipster Shop | Задание со ⭐
Выясните причину, по которой pod frontend находится в статусе
Error
Создайте новый манифест frontend-pod-healthy.yaml. При его
применении ошибка должна исчезнуть. Подсказки можно найти:
В логах - kubectl logs frontend
В манифесте по
В результате, после применения исправленного манифеста pod
frontend должен находиться в статусе Running (опустим вопрос,
действительно ли микросервис работает)
Поместите исправленный манифест frontend-pod-healthy.yaml
в директорию kubernetes-intro
ссылке
Избавляем бизнес от ИТ-зависимости
3 . 6
Проверка ДЗ
Результаты вашей работы должны быть добавлены в ветку
kubernetes-intro вашего GitHub репозитория login_platform
В README.md рекомендуется внести описание проделанной
работы
Необходимо заполнить описание Pull Request по шаблону,
созданному в предыдущей домашней работе
Избавляем бизнес от ИТ-зависимости
4 . 1
Проверка ДЗ
Создайте Pull Request к ветке master (описание PR рекомендуется
заполнять)
Добавьте метку kubernetes-intro к вашему PR
После того как автоматизированные тесты проверят
корректность выполнения ДЗ, необходимо сделать merge ветки
kubernetes-intro в master и закрыть PR
Если у вас возникли вопросы по ДЗ и необходима консультация
преподавателей - после прохождения автотестов добавьте к PR
метку Review Required и не мерджите PR самостоятельно
Избавляем бизнес от ИТ-зависимости
4 . 2
Избавляем бизнес от ИТ-зависимости
Проверка ДЗ
Структура репозитория после выполнения домашнего задания
(с учетом необязательного задания со ⭐